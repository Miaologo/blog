---
title: iOS开发之Video基础必备
date: 2019-08-16 19:52:25
tags:
	- iOS	
	- Video
---

## YUV 详解

### RGB颜色编码

RGB 图像中，每个像素点都有红、绿、蓝三个颜色通道，其中每个通道都占用 8 bit，也就是一个字节，那么一个像素点也就占用 24 bit，也就是三个字节。

一张 1280 * 720 大小的图片，就占用 1280 * 720 * 3 / 1024 / 1024 = 2.63 MB 存储空间。

### YUV颜色编码

在 YUV空间中，每一个颜色有一个亮度信号 Y，和两个色度信号 U 和V。 如果没有U/V分量，那么显示出来的图像就是黑白的。

对于YUV来说，并不是每个Y分量就对应一个U/V分量，根据不同的采样格式，可以一个Y分量对应一个U/V分量，也可以多个Y分量共享一个U/V分量。

#### YUV常见采样格式

假设原图像结构为：[Y0 U0 V0]、[Y1 U1 V1]、[Y2 U2 V2]、[Y3 U3 V3]

**YUV4:4:4:**即 Y:U:V = 4:4:4 ,表示一个Y分量对应一个U/V分量，采样完为：Y0U0V0Y1U1V1Y2U2V2Y3U3V3；这种采样结束后图片大小跟rgb编码方式并无区别。

**YUV4:2:2:**即 Y:U:V = 4:2:2 ,表示Y 分量和 UV 分量按照 2 : 1 的比例采样，采样完为：Y0U0Y1V1Y2U2Y3V3;该方式采样结束后图片大小为： （1280 * 720 * 8 + 1280 * 720 * 8/2 + 1280 * 720 * 8/2）/ 8 / 1024 / 1024 = 1.76 MB 。

**YUV4:2:0（现在比较常用的）:**即 Y:U:V = 4:2:0 ,并不是指只采样 U 分量而不采样 V 分量，而是指，在每一行扫描时，只扫描一种色度分量（U 或者 V），和 Y 分量按照 2 : 1 的方式采样：**原始图像：**[Y0 U0 V0]、[Y1 U1 V1]、 [Y2 U2 V2]、 [Y3 U3 V3] [Y4 U4 V4]、[Y5 U5 V5]、 [Y6 U6 V6]、 [Y7 U7 V7]**采样完：**Y0U0Y1Y2U2Y3 Y4V4Y5Y6V6Y7 此时图片大小变为： （1280 * 720 * 8 + 1280 * 720 * 0.25 * 8 * 2）/ 8 / 1024 / 1024 = 1.32 MB 。

**YUV和RGB的转换:**

```
Y = 0.257R + 0.504G + 0.098B + 16
U = 0.148R - 0.291G + 0.439B + 128
V = 0.439R - 0.368G - 0.071B + 128

B = 1.164(Y - 16) + 2.018(U - 128)
G = 1.164(Y - 16) - 0.813(V - 128) - 0.391(U - 128)
R = 1.164(Y - 16) + 1.596(V - 128)
复制代码
```

#### YUV存储格式

YUV的存储格式分为：plannar(平面)和packed(打包)

- **plannar(平面):**先连续存储所有像素点的 Y 分量，然后存储 U 分量，最后是 V 分量。

> **YU12 和 YV12 格式**YU12 和 YV12 格式都属于 YUV 420P 类型，即先存储 Y 分量，再存储 U、V 分量，区别在于：YU12 是先 Y 再 U 后 V，而 YV12 是先 Y 再 V 后 U 。

> **YU12 : 也叫做I420(PC端使用) :**YYYYYYYY UU VV --> YUV420P

> **YV12 :**YYYYYYYY VV UU --> YUV420P

- **packed(打包，移动端使用):**每个像素点的 Y、U、V 分量是连续交替存储的.

> **NV12 和 NV21 格式**NV12 和 NV21 格式都属于 YUV420SP 类型。它也是先存储了 Y 分量，但接下来并不是再存储所有的 U 或者 V 分量，而是把 UV 分量交替连续存储。 NV12 是 IOS 中有的模式，它的存储顺序是先存 Y 分量，再 UV 进行交替存储。 NV21 是 安卓 中有的模式，它的存储顺序是先存 Y 分量，在 VU 交替存储。

> **NV12 :**YYYYYYYY UVUV --> YUV420SP

> **NV21 :**YYYYYYYY VUVU --> YUV420SP

**开发过程中，有可能出现iOS端的视频在Android端发生了倒置或者翻转，那么就可能是因为两边的YUV存储格式不一样导致的。**



----

https://juejin.im/post/5d43a6d8f265da03bd04fd57

## H264结构与码流解析

### H264结构图：

![image.png](https://user-gold-cdn.xitu.io/2019/8/2/16c5043a8fbe3672?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

H264视频压缩后会成为一个序列帧，帧里包含图像，图像分为很多片，每个片可以分为宏块，每个宏块由许多子块组成**H264结构中，一个视频图像编码后的数据叫做一帧，一帧由一个片（slice）或多个片组成，一个片由一个或多个宏块（MB）组成，一个宏块由16x16的yuv数据组成。宏块作为H264编码的基本单位。**

- **场和帧**：视频的一场或者一帧可以用来产生一个编码图像。在电视中，每个电视帧都是通过扫描屏幕两次而产生的，第二个扫描的线条刚好填满第一次扫描所留下的缝隙。每个扫描即称为一个场。因此 30 帧/秒的电视画面实际上为 60 场/秒
- **片**：每个图像中，若干个宏块被排列成片。片的目的：为了限制误码的扩散和传输，使编码片相互间保持独立。片共有5种类型：I片（只包含I宏块）、P片（P和I宏块）、B片（B和I宏块）、SP片（用于不同编码流之间的切换）和SI片（特殊类型的编码宏块）。
- **宏块**：一个编码图像首先要划分成多个块（4x4 像素）才能进行处理，显然宏块应该是整数个块组成，通常宏块大小为16x16个像素。宏块分为I、P、B宏块，I宏块只能利用当前片中已解码的像素作为参考进行帧内预测；P宏块可以利用前面已解码的图像作为参考图像进行帧内预测；B宏块则是利用前后向的参考图形进行帧内预测

### H264编码分层

- **NAL层:（Network Abstraction Layer,视频数据网络抽象层）**： 它的作用是H264只要在网络上传输，在传输的过程每个包以太网是1500字节，而H264的帧往往会大于1500字节，所以要进行拆包，将一个帧拆成多个包进行传输，所有的拆包或者组包都是通过NAL层去处理的。
- **VCL层:（Video Coding Layer,视频数据编码层）**： 对视频原始数据进行压缩

### 码流的基本概念

- **SODB:(String of Data Bits,原始数据比特流)**：由VCL层产生，数据长度不一定是8的倍数，所以处理起来比较麻烦
- **RBSP:(Raw Byte Sequence Payload,SODB+trailing bits,编码后的数据流)**：算法是在SODB最后一位补1，不按字节对齐补0，如果补齐0，不知道在哪里结束，所以补1，如果不够8位则按位补0
- **EBSP:(Encapsulate Byte Sequence Payload)**：生成编码后的数据流之后,我们还要在每个帧之前加一个起始位，需要开发者人为添加。起始位一般是十六进制的0001。但是在整个编码后的数据里,可能会出来连续的2个0x00。那这样就与起始位产生了冲突.那怎么处理了? H264规范里说明如果处理2个连续的0x00，就额外增加一个0x03 。这样就能预防压缩后的数据与起始位产生冲突
- **NALU: （NAL Header(1B)+EBSP）**.NALU就是在EBSP的基础上加1B的网络头.

### NALU解析



![image.png](https://user-gold-cdn.xitu.io/2019/8/2/16c5043a9ea9b9b2?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



- **NALU头结构：NALU类型(5bit)、重要性指示位(2bit)、禁止位(1bit)**：第1位为禁位，默认固定为0，如果接收到的为1，那么就需要丢弃该单元；第2-3位表示重要性，00表示最不重要，11表示最重要，我们可以在解码来不及的情况下舍弃一些不重要的单元；第4-8位用来表示NALU的类型

- **NALU类型：1～12由H.264使用，24～31由H.264以外的应用使用**：类型图如下：

  ![image.png](https://user-gold-cdn.xitu.io/2019/8/2/16c5043a9727c77a?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

  

- **切片与宏块的关系**：每个切片包括切片头和切片数据，每个切片数据包括了很多宏块。每个宏块包括了宏块类型、宏块预测、残差效果：

  ![image.png](https://user-gold-cdn.xitu.io/2019/8/2/16c5043a94f0fe51?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

  

- **切片头**：包含了一组片的信息，比如片的数量，顺序等等

### H264码流分层结构图



![image.png](https://user-gold-cdn.xitu.io/2019/8/2/16c5043b57a1b109?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)


